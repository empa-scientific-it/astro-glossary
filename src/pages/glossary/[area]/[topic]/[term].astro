---
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';
import { getCollection, render } from 'astro:content';
import { getArea, getTopic, glossaryConfig } from '../../../../config/glossary';

type TermEntry = Awaited<ReturnType<typeof getCollection<'glossary'>>>[number];

export async function getStaticPaths() {
  const allTerms = await getCollection('glossary');

  // Build a map of term ID -> term for related term lookups
  const termsById = new Map(allTerms.map((t) => [t.id, t]));

  const paths = [];

  for (const term of allTerms) {
    for (const placement of term.data.placements) {
      paths.push({
        params: {
          area: placement.area,
          topic: placement.topic,
          term: term.id,
        },
        props: {
          term,
          currentArea: placement.area,
          currentTopic: placement.topic,
          termsById,
        },
      });
    }
  }

  return paths;
}

interface Props {
  term: TermEntry;
  currentArea: string;
  currentTopic: string;
  termsById: Map<string, TermEntry>;
}

const { term, currentArea, currentTopic, termsById } = Astro.props;

// Render the MDX content
const { Content, headings } = await render(term);

// Get area and topic metadata
const area = getArea(currentArea);
const topic = getTopic(currentArea, currentTopic);

// Check if term appears in other placements
const otherPlacements = term.data.placements.filter(
  (p) => p.area !== currentArea || p.topic !== currentTopic
);

// Build contextual sidebar
const currentAreaConfig = glossaryConfig.areas.find((a) => a.slug === currentArea);
const sidebar = [
  {
    label: 'Glossary',
    link: '/glossary/',
  },
  ...(currentAreaConfig
    ? [
        {
          label: area?.title || currentArea,
          items: currentAreaConfig.topics.map((t) => ({
            label: t.title,
            link: `/glossary/${currentArea}/${t.slug}/`,
          })),
        },
      ]
    : []),
];
---

<StarlightPage
  frontmatter={{
    title: term.data.title,
    description: term.data.description,
  }}
  headings={headings}
  sidebar={sidebar}
>
  <!-- Breadcrumb -->
  <nav class="breadcrumb" aria-label="Breadcrumb">
    <a href="/glossary/">Glossary</a>
    <span class="separator">/</span>
    <a href={`/glossary/#${currentArea}`}>{area?.title}</a>
    <span class="separator">/</span>
    <a href={`/glossary/#${currentArea}-${currentTopic}`}>{topic?.title}</a>
    <span class="separator">/</span>
    <span class="current">{term.data.title}</span>
  </nav>

  <!-- Term description -->
  <p class="term-description">{term.data.description}</p>

  <!-- Other placements notice -->
  {
    otherPlacements.length > 0 && (
      <aside class="also-in">
        <strong>Also appears in:</strong>
        <ul>
          {otherPlacements.map((p) => {
            const otherArea = getArea(p.area);
            const otherTopic = getTopic(p.area, p.topic);
            return (
              <li>
                <a href={`/glossary/${p.area}/${p.topic}/${term.id}`}>
                  {otherArea?.title} &rarr; {otherTopic?.title}
                </a>
              </li>
            );
          })}
        </ul>
      </aside>
    )
  }

  <!-- Aliases -->
  {
    term.data.aliases && term.data.aliases.length > 0 && (
      <div class="aliases">
        <strong>Also known as:</strong> {term.data.aliases.join(', ')}
      </div>
    )
  }

  <!-- Main content -->
  <div class="content">
    <Content />
  </div>

  <!-- Related terms -->
  {
    term.data.relatedTerms && term.data.relatedTerms.length > 0 && (
      <aside class="related-terms">
        <h2>Related Terms</h2>
        <ul>
          {term.data.relatedTerms.map((slug) => {
            const relatedTerm = termsById.get(slug);
            if (!relatedTerm) return null;
            const firstPlacement = relatedTerm.data.placements[0];
            return (
              <li>
                <a href={`/glossary/${firstPlacement.area}/${firstPlacement.topic}/${slug}`}>
                  {relatedTerm.data.title}
                </a>
              </li>
            );
          })}
        </ul>
      </aside>
    )
  }

  <!-- External links -->
  {
    term.data.externalLinks && term.data.externalLinks.length > 0 && (
      <aside class="external-links">
        <h2>External Resources</h2>
        <ul>
          {term.data.externalLinks.map((link) => (
            <li>
              <a href={link.url} target="_blank" rel="noopener noreferrer">
                {link.title}
              </a>
            </li>
          ))}
        </ul>
      </aside>
    )
  }
</StarlightPage>

<style>
  .breadcrumb {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    font-size: 0.9rem;
  }

  .breadcrumb a {
    color: var(--sl-color-text-accent);
    text-decoration: none;
  }

  .breadcrumb a:hover {
    text-decoration: underline;
  }

  .breadcrumb .separator {
    color: var(--sl-color-gray-4);
  }

  .breadcrumb .current {
    color: var(--sl-color-gray-2);
  }

  .term-description {
    font-size: 1.15rem;
    color: var(--sl-color-gray-2);
    margin-bottom: 1.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--sl-color-gray-5);
  }

  .also-in {
    background: var(--sl-color-blue-low);
    border-left: 4px solid var(--sl-color-blue);
    padding: 1rem;
    margin-bottom: 1.5rem;
    border-radius: 0 0.5rem 0.5rem 0;
  }

  .also-in ul {
    margin: 0.5rem 0 0 1.5rem;
    padding: 0;
  }

  .also-in a {
    color: var(--sl-color-text-accent);
  }

  .aliases {
    color: var(--sl-color-gray-3);
    margin-bottom: 1.5rem;
    font-size: 0.95rem;
  }

  .content {
    margin-bottom: 2rem;
  }

  .related-terms,
  .external-links {
    background: var(--sl-color-gray-6);
    padding: 1rem 1.5rem;
    border-radius: 0.5rem;
    margin-top: 2rem;
  }

  .related-terms h2,
  .external-links h2 {
    font-size: 1rem;
    margin: 0 0 0.75rem 0;
  }

  .related-terms ul,
  .external-links ul {
    margin: 0;
    padding-left: 1.5rem;
  }

  .related-terms a,
  .external-links a {
    color: var(--sl-color-text-accent);
  }
</style>
